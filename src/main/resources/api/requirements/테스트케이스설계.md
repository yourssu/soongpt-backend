# 과목 추천 통합 테스트 설계

## 목표

`/api/courses/recommend/all?category=...` 엔드포인트의 모든 케이스를 커버하는 통합 테스트.
`RusaintUsaintDataResponse`(userSession)를 모킹하되, **실제 DB 과목 데이터를 기반으로 자동 생성**하여 데이터 변경(26-1→26-2)에도 세션 모킹 로직만 재실행하면 유효한 테스트가 되도록 한다.

---

## 핵심 설계: 자동 세션 생성기 (`MockSessionBuilder`)

### 개념

수동으로 과목코드를 하드코딩하지 않는다. 대신:

1. **DB에서 실제 과목 데이터를 조회**하여 학과별·카테고리별 과목코드를 가져온다
2. **규칙 기반으로 기이수 과목(takenCourses)을 자동 선별**한다
3. 이를 `RusaintUsaintDataResponse`로 조립한다

```
MockSessionBuilder
  .department("컴퓨터학부")        // → departmentId, collegeId 자동 resolve
  .admissionYear(2021)            // → schoolId=21, grade=3 (현재년도 기준)
  .grade(3)                       // 명시적 학년 지정 (기본: 현재년도-입학년도+1)
  .doubleMajor("글로벌미디어학부")  // flags.doubleMajorDepartment
  .minor(null)                    // flags.minorDepartment
  .teaching(true)                 // flags.teaching
  .chapel(satisfied = true)       // 채플 충족 여부
  .majorBasic(...)                // 전기 progress + 이수 전략
  .majorRequired(...)             // 전필 progress + 이수 전략
  .majorElective(...)             // 전선 progress + 이수 전략
  .generalRequired(...)           // 교필 progress + 이수 전략
  .generalElective(...)           // 교선 progress
  .doubleMajorRequired(...)       // 복필 progress + 이수 전략
  .doubleMajorElective(...)       // 복선 progress + 이수 전략
  .retake(...)                    // 재수강 전략
  .build()                        // → RusaintUsaintDataResponse
```

### 이수 전략 (TakenStrategy)

각 카테고리별로 기이수 과목을 어떻게 선별할지 전략을 지정:

```kotlin
enum class TakenStrategy {
    NONE,              // 아무것도 안 들음
    ALL,               // 전부 이수
    PARTIAL_ON_TIME,   // 현재 학년 이하 과목 중 일부만 이수
    PARTIAL_LATE,      // 이미 지나간 학년 과목 일부 미이수 (LATE 유발)
    MOST,              // 거의 다 이수 (1-2개 남음)
    SPECIFIC_CODES,    // 특정 코드 지정 (하드코딩 필요 시)
}
```

### 이수 과목 자동 선별 로직 (핵심)

```
1. CourseRepository.findCoursesWithTargetByCategory(category, departmentId, ...) 호출
2. 결과에서 baseCode 기준으로 distinct
3. targetGrades 기반으로 분류:
   - pastGrade 과목: targetGrades.max() < userGrade  (이미 지난 학년 → LATE 대상)
   - currentGrade 과목: userGrade in targetGrades   (현재 학년 → ON_TIME)
   - futureGrade 과목: targetGrades.min() > userGrade (미래 학년)
4. TakenStrategy에 따라:
   - NONE → takenCodes = 빈 리스트
   - ALL → takenCodes = 모든 baseCode
   - PARTIAL_ON_TIME → pastGrade 전부 이수 + currentGrade 절반 이수
   - PARTIAL_LATE → pastGrade 일부만 이수 (LATE 과목 발생)
   - MOST → pastGrade 전부 + currentGrade 대부분 이수 (1-2개 남김)
```

### progress 자동 계산

```
실제 DB 과목의 학점을 합산하여:
- required = 졸업요건 학점 (테스트 케이스에서 지정)
- completed = 이수 전략에 따라 선별된 과목의 학점 합
- satisfied = completed >= required
```

---

## 테스트 케이스 4개

### Case 1: 컴퓨터학부 21학번 3학년

| 항목     | 설정                                                                            |
| -------- | ------------------------------------------------------------------------------- |
| 학과     | 컴퓨터학부                                                                      |
| 입학년도 | 2021                                                                            |
| 학년     | 3                                                                               |
| 전기     | `PARTIAL_LATE` — 1-2학년 전기 중 일부 미이수 (LATE 과목 존재)                |
| 전필     | `PARTIAL_ON_TIME` — 과거 학년 전부 + 현재 일부                               |
| 전선     | `PARTIAL_ON_TIME` — 절반 정도 이수                                           |
| 복전     | 글로벌미디어학부, 복필 `MOST` (1개 빼고 다 이수), 복선 `ALL` (이미 다 들음) |
| 교직     | teaching=true, 3개 영역 중 일부 이수                                            |
| 채플     | satisfied=true                                                                  |
| 교필     | 22학번 이하이므로 분야 구분 없이 과목 단위 필터링.`PARTIAL_ON_TIME`           |
| 교선     | 3개 분야 중 3개 다 충족 (progress satisfied 가까이)                             |
| 재수강   | 없음 (lowGradeSubjectCodes = 빈 리스트)                                         |

**검증 포인트:**

- 전기: LATE 과목이 courses에 timing=LATE로 포함
- 전필/전선: ON_TIME 과목 정상 추천
- 복필: progress.satisfied=false, 1개 과목만 추천
- 복선: progress.satisfied=true, "이미 모두 이수" 메시지
- 교직: 교직 과목 추천됨
- 채플: satisfied=true
- 교필: lateFields=null (22학번 이하), 과목 단위 필터
- 교선: 충족 분야는 빈 리스트, 미충족 분야만 과목 포함
- 재수강: "재수강 가능한 C+ 이하 과목이 없습니다."

---

### Case 2: 경영학부 24학번 2학년

| 항목     | 설정                                                                                                                |
| -------- | ------------------------------------------------------------------------------------------------------------------- |
| 학과     | 경영학부                                                                                                            |
| 입학년도 | 2024                                                                                                                |
| 학년     | 2                                                                                                                   |
| 전기     | 경영은 커리큘럼에 전기 없음 → graduationSummary.majorFoundation = null → "졸업사정표에 전공기초 항목이 없습니다." |
| 전필     | `PARTIAL_ON_TIME` — 1학년 전필 이수 + 2학년 전필 일부                                                            |
| 전선     | `NONE` — 아직 전선 안 들음                                                                                       |
| 부전공   | 통계학과 (정보통계보험수리학과)                                                                                     |
| 교직     | teaching=false → "교직이수 대상이 아닙니다."                                                                       |
| 채플     | satisfied=false                                                                                                     |
| 교필     | 23학번 이상. 1학년 분야 미이수 → LATE 분야 존재. 2학년 분야 → ON_TIME                                             |
| 교선     | 3개 영역 중 2개만 만족 → 미충족 1개 분야 과목 추천                                                                 |
| 재수강   | 없음                                                                                                                |

**검증 포인트:**

- 전기: noDataResponse ("졸업사정표에 전공기초 항목이 없습니다.")
- 전필: courses 존재, timing 혼재
- 전선: courses 많이 추천 (안 들었으니까)
- 부전공: 부필/부선 과목 추천
- 교직: "교직이수 대상이 아닙니다."
- 채플: satisfied=false → 채플 과목 추천
- 교필: lateFields에 1학년 분야 포함, courses에 2학년 분야 과목
- 교선: 2개 충족 분야 빈 리스트, 1개 미충족 분야 과목 추천

---

### Case 3: 글로벌통상학과 22학번 3학년

| 항목     | 설정                                                                         |
| -------- | ---------------------------------------------------------------------------- |
| 학과     | 글로벌통상학과                                                               |
| 입학년도 | 2022                                                                         |
| 학년     | 3                                                                            |
| 전기     | 글통은 전필 없음 → graduationSummary.majorRequired = null → noDataResponse |
| 전필     | noDataResponse (전필 없음)                                                   |
| 전선     | `PARTIAL_ON_TIME`                                                          |
| 복전     | 수학과, 복필 `ALL` (다 이수), 복선 `PARTIAL_LATE` (좀 많이 남음)         |
| 교직     | teaching=true, 특성화영역 빼고 다 이수                                       |
| 채플     | satisfied=true                                                               |
| 교필     | 22학번 이하 → lateFields 없음                                               |
| 교선     | `PARTIAL_ON_TIME`                                                          |
| 재수강   | 교필 1개, 교선 1개, 전기 1개 (lowGradeSubjectCodes에 3개 baseCode)           |

**검증 포인트:**

- 전필: noDataResponse
- 전기/전선: 정상 추천
- 복필: satisfied 메시지
- 복선: LATE 과목 존재하는 추천 목록
- 교직: 특성화영역 과목만 추천
- 재수강: 3개 과목 추천 (해당 baseCode가 이번 학기 개설되는 경우만)

---

### Case 4: 회계학과 26학번 1학년

| 항목     | 설정                                                                           |
| -------- | ------------------------------------------------------------------------------ |
| 학과     | 회계학과                                                                       |
| 입학년도 | 2026                                                                           |
| 학년     | 1                                                                              |
| 전기     | 회계는 전기 없음 → noDataResponse                                             |
| 전필     | `NONE` — 1학년 1학기, 아직 아무것도 안 들음                                 |
| 전선     | `NONE`                                                                       |
| 복전     | 없음 (flags.doubleMajorDepartment = null) → "복수전공을 등록하지 않았습니다." |
| 부전공   | 없음                                                                           |
| 교직     | teaching=false                                                                 |
| 채플     | satisfied=false                                                                |
| 교필     | 23학번 이상, 1학년. 모든 1학년 분야 ON_TIME, LATE 없음                         |
| 교선     | 아무것도 안 들음 → 모든 분야 과목 추천                                        |
| 재수강   | 교필 1개, 전필 1개 (신입생인데 재수강? → 엣지케이스)                          |

**검증 포인트:**

- 1학년이라 LATE 과목 없음 (모두 ON_TIME)
- 전기: noDataResponse
- 전필: 1학년 대상 과목만 추천
- 전선: 전학년 과목 추천
- 복전/부전공: 미등록 메시지
- 교직: 비대상 메시지
- 교필: lateFields=null (1학년이라 늦은 분야 없음), 모든 1학년 분야 과목
- 재수강: lowGradeSubjectCodes 있으면 해당 과목 개설 시 추천

---

## 엣지케이스 매핑 (recommend_edge_cases.md 대응)

| # | 엣지케이스                                                 | 커버하는 테스트 케이스                          |
| - | ---------------------------------------------------------- | ----------------------------------------------- |
| 1 | course=null, progress 0/0/true (해당 이수구분 자체가 없음) | Case2 전기, Case4 전기                          |
| 2 | course=null, progress required>0/false (남았는데 안 열림)  | Case1-3 전기/전필에서 empty 응답 발생 가능      |
| 3 | course=null, progress required>0/true (이미 다 들음)       | Case1 복선, Case3 복필                          |
| 4 | 교직 T/F에 따른 progress 차이                              | Case1(T), Case2(F), Case3(T), Case4(F)          |
| 5 | 재수강 (없는/있는데 안 열리는/있는)                        | Case1(없음), Case3(있음 3개), Case4(있음 2개)   |
| 6 | 졸업사정표 자체 없음 (graduationSummary=null)              | **Case 5** (course5_no_graduation_report) |

---

## Case 5: 졸업사정표 없음 (1-1 / rusaint 미제공)

| 항목              | 설정                                                                                                |
| ----------------- | --------------------------------------------------------------------------------------------------- |
| 시나리오          | rusaint-service에서 졸업사정표가 아예 없는 경우 (1-1 또는 미제공)                                   |
| graduationSummary | **null** (MockSessionBuilder.noGraduationReport())                                            |
| 기대 동작         | **에러가 아닌 경고**: `warnings`에 `NO_GRADUATION_REPORT` 추가, 카테고리별 noDataResponse |

**검증 포인트:**

- `response.warnings`에 `NO_GRADUATION_DATA`, `NO_GRADUATION_REPORT` 포함
- 전기/전필/전선/교필: `progress.required = -2`, `progress.completed = -2` (Progress.unavailable), 메시지 "졸업사정표에 ... 없습니다"
- **재수강·교직**: 졸업사정표 데이터 자체가 없으므로 `-1`(해당 없음)이 아니라 `-2`(제공 불가)로 통일. `progress = -2,-2,false`, 메시지 "졸업사정표가 없어 … 추천을 제공할 수 없습니다", courses 빈 리스트
- 복전(등록 시): "졸업사정표에 복수전공필수/선택 항목이 없습니다.", courses 빈 리스트
- 부전공 미등록 시: "부전공을 등록하지 않았습니다."

---

## 통합 테스트 검증 매핑 (요구사항 ↔ assertion)

아래는 **테스트케이스설계.md 검증 포인트**가 `CourseRecommendIntegrationTest`에서 **어떤 boolean assertion으로 검증되는지** 매핑한 표다.
요구사항 반영 여부 확인 시 이 표와 테스트 코드의 주석(`——— 테스트케이스설계.md Case N 검증 포인트 ———`)을 함께 보면 된다.

| Case | 검증 포인트                       | 테스트에서 검증 방식 (boolean + raw response)                                      |
| ---- | --------------------------------- | ---------------------------------------------------------------------------------- |
| 1    | 전기 LATE 포함                    | `MAJOR_BASIC`: courses 있으면 progress.satisfied=false, LATE 있으면 message=null |
| 1    | 전필/전선 ON_TIME                 | `MAJOR_REQUIRED`/`MAJOR_ELECTIVE` progress.satisfied=false                     |
| 1    | 복필 1개만 추천                   | `DOUBLE_MAJOR_REQUIRED` progress.satisfied=false, courses.size==1(있을 때)       |
| 1    | 복선 "이미 모두 이수"             | `DOUBLE_MAJOR_ELECTIVE` satisfied 시 message 포함, courses.size=0                |
| 1    | 교직 과목 추천                    | `TEACHING` courses 비어있지 않거나 message 존재                                  |
| 1    | 교필 lateFields=null              | `GENERAL_REQUIRED` lateFields == null (22학번 이하)                              |
| 1    | 재수강 없음                       | `RETAKE` message = "재수강 가능한 C+ 이하 과목이 없습니다."                      |
| 2    | 전기 noData                       | `MAJOR_BASIC` progress 0/0/true                                                  |
| 2    | 전필/전선/부전공                  | 전필 courses 존재, 전선 satisfied=false, MINOR courses 또는 message                |
| 2    | 교직 비대상                       | `TEACHING` message "교직이수 대상이 아닙니다"                                    |
| 2    | 교필 lateFields                   | GENERAL_REQUIRED courses 또는 lateFields 존재                                      |
| 3    | 전필 noData                       | `MAJOR_REQUIRED` 0/0/true                                                        |
| 3    | 복필/복선/교직                    | 복필 satisfied 시 message, 복선 satisfied=false, TEACHING 과목 또는 메시지         |
| 4    | 전기 noData, 복전/부전공 미등록   | MAJOR_BASIC 0/0/true, DMRE "복수전공을 등록하지 않았습니다.", MINOR "부전공"       |
| 4    | 교직 비대상, 교필 lateFields=null | TEACHING 비대상 메시지, GENERAL_REQUIRED lateFields=null                           |
| 4    | 재수강 없음                       | RETAKE 메시지                                                                      |
| 5    | 졸업사정표 없음(1-1)             | warnings NO_GRADUATION_DATA·NO_GRADUATION_REPORT, 전기/전필/전선/교필·재수강·교직 모두 progress=-2/-2 |

- **기이수 과목 주석**: 각 케이스에서 `printTakenCoursesWithNames(session)`으로 **과목코드: 과목명** 출력 (무슨 과목인지 확인 가능).
- **Raw response**: 매 케이스 `println(prettyPrint(responseBody))`로 실제 응답 JSON 출력.
- **유지보수**: MockSessionBuilder가 DB에서 과목 조회 후 전략만 적용하므로, 26-1→26-2 데이터 변경 시에도 로직 한 번만 맞추면 세션이 실제 데이터처럼 구성됨.

---

## 테스트 구조

```
src/test/kotlin/com/yourssu/soongpt/domain/course/application/
└── CourseRecommendIntegrationTest.kt

    // 1. @SpringBootTest + test profile (H2 + 실제 data init)
    // 2. SyncSessionStore 모킹 → MockSessionBuilder로 생성한 세션 주입
    // 3. 각 케이스마다:
    //    a. MockSessionBuilder로 세션 생성 (DB 조회 기반 자동)
    //    b. /api/courses/recommend/all 호출
    //    c. raw response JSON 출력 (디버깅용)
    //    d. boolean assertion (요구사항 검증)
```

### 검증 방식 (dual verification)

```kotlin
// 1. Raw response 출력 (육안 확인용)
println("=== Case 1: 컴퓨터학부 21학번 3학년 ===")
println(objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(response))

// 2. Boolean assertion (자동화 검증)
response.categories.find { it.category == "MAJOR_BASIC" }!!.let { majorBasic ->
    majorBasic.courses.any { it.timing == CourseTiming.LATE } shouldBe true  // LATE 과목 존재
    majorBasic.progress!!.satisfied shouldBe false
}
response.categories.find { it.category == "DOUBLE_MAJOR_ELECTIVE" }!!.let { dme ->
    dme.message shouldBe "복수전공선택 학점을 이미 모두 이수하셨습니다."
    dme.courses shouldHaveSize 0
}
```

---

## MockSessionBuilder 핵심 로직 (의사코드)

```kotlin
class MockSessionBuilder(
    private val courseRepository: CourseRepository,
    private val departmentReader: DepartmentReader,
) {
    // ... builder fields ...

    fun buildTakenCourses(): List<RusaintTakenCourseDto> {
        val allTaken = mutableListOf<String>()

        // 전기
        if (majorBasicStrategy != TakenStrategy.NONE) {
            val dept = departmentReader.getByName(departmentName)
            val courses = courseRepository.findCoursesWithTargetByCategory(
                Category.MAJOR_BASIC, dept.id!!, dept.collegeId, grade
            ).distinctBy { it.course.baseCode() }

            val selected = applyStrategy(courses, majorBasicStrategy, grade)
            allTaken.addAll(selected.map { it.course.baseCode().toString() })
        }
        // ... 전필, 전선, 교필, 교선 동일 패턴 ...

        // 복전
        if (doubleMajorDept != null) {
            // doubleMajorDept 기준으로 복필/복선 과목 조회 & 전략 적용
        }

        // 학기별로 분배 (1학년1학기 ~ 현재학기-1)
        return distributeBySemester(allTaken, admissionYear, currentSemester)
    }

    private fun applyStrategy(
        courses: List<CourseWithTarget>,
        strategy: TakenStrategy,
        userGrade: Int
    ): List<CourseWithTarget> {
        val past = courses.filter { it.isLateFor(userGrade) }     // 지난 학년
        val current = courses.filter { !it.isLateFor(userGrade) } // 현재 학년

        return when (strategy) {
            NONE -> emptyList()
            ALL -> courses
            PARTIAL_ON_TIME -> past + current.take(current.size / 2)
            PARTIAL_LATE -> past.dropLast(past.size / 3) + current.take(1)
            MOST -> past + current.dropLast(minOf(2, current.size))
            SPECIFIC_CODES -> ... // 직접 지정
        }
    }

    // 이수 과목을 학기별로 자연스럽게 분배
    private fun distributeBySemester(
        codes: List<String>,
        admissionYear: Int,
        currentSemester: Int
    ): List<RusaintTakenCourseDto> {
        val semesters = generateSemesters(admissionYear, currentYear, currentSemester)
        // 과목을 학기별로 균등 분배
        return codes.chunked(codes.size / semesters.size + 1)
            .zip(semesters)
            .map { (codes, sem) -> RusaintTakenCourseDto(sem.year, sem.semester, codes) }
    }
}
```

---

## 유지보수 포인트

1. **과목 데이터 변경 시**: `MockSessionBuilder`가 DB에서 실시간 조회하므로, 26-2 데이터로 바뀌어도 테스트 자체는 유효
2. **새 카테고리 추가 시**: `MockSessionBuilder`에 빌더 메서드 추가 + 테스트 케이스에 assertion 추가
3. **주석**: 각 테스트 케이스의 기이수 과목이 어떤 과목인지 `buildTakenCourses()` 호출 후 로그로 출력

```kotlin
// 빌드 후 로그 출력
val session = builder.build()
println("=== 기이수 과목 목록 ===")
session.takenCourses.forEach { semester ->
    println("[${semester.year}-${semester.semester}]")
    semester.subjectCodes.forEach { code ->
        val course = courseRepository.findByBaseCode(code.toLong())
        println("  $code: ${course?.name ?: "미확인"} (${course?.category})")
    }
}
```

---

## 추가 엣지케이스 단독 테스트

위 4개 케이스 외에, 아래 엣지케이스는 별도 단위 테스트로 커버:

| 엣지케이스                                         | 테스트                                               |
| -------------------------------------------------- | ---------------------------------------------------- |
| graduationSummary 자체 null (1-1 또는 사정표 없음) | 모든 카테고리가 noDataResponse 반환 확인             |
| 재수강 대상인데 이번 학기 미개설                   | lowGradeSubjectCodes에 없는 baseCode → empty 메시지 |
| 복전 등록했지만 해당 학과 과목 0개 개설            | empty 메시지 반환 확인                               |
| 교필 분야 전부 LATE (고학년 미이수 많음)           | lateFields에 모든 분야, courses 빈 리스트            |

# 채플/교선 이수현황 응답 조립 가이드

## 개요

`available-chapels`, `available-general-electives` 엔드포인트 응답에
이수현황(satisfied, progress)을 flat하게 붙여서 보내야 한다.

DTO와 계산 로직은 이미 만들어져 있고, **TimetableService에서 조립만 하면 된다.**

---

## 제공되는 컴포넌트

### 1. DTO

| 클래스                                | 위치                        | 필드                                                                                                |
| ------------------------------------- | --------------------------- | --------------------------------------------------------------------------------------------------- |
| `AvailableChapelsResponse`          | `timetable/business/dto/` | `satisfied: Boolean?`, `courses: List<TimetableCourseResponse>`                                 |
| `AvailableGeneralElectivesResponse` | `timetable/business/dto/` | `progress: GeneralElectiveProgress?`, `courses: List<GeneralElectiveDto>`                       |
| `GeneralElectiveProgress`           | 같은 파일                   | `required: Int?`, `completed: Int?`, `satisfied: Boolean`, `fieldCredits: Map<String, Int>` |

### 2. 사용할 메서드

| 메서드                                                                                  | 위치                              | 역할                                                                 |
| --------------------------------------------------------------------------------------- | --------------------------------- | -------------------------------------------------------------------- |
| `recommendContextResolver.resolveOptional()`                                          | `RecommendContextResolver`      | ThreadLocal에서 사용자 컨텍스트 조회. 로그인 안 됐으면 `null` 반환 |
| `generalCourseRecommendService.computeTakenFieldCredits(takenSubjectCodes, schoolId)` | `GeneralCourseRecommendService` | 학번 기준 분야별 이수 학점 계산 →`Map<String, Int>`               |

> `resolveOptional()`은 `CurrentPseudonymFilter`가 세팅한 ThreadLocal 값을 사용한다.
> 컨트롤러/서비스에서 추가 설정 필요 없음.

---

## 조립 방법

### TimetableService 의존성 추가

```kotlin
class TimetableService(
    // 기존 의존성...
    private val recommendContextResolver: RecommendContextResolver,
    private val generalCourseRecommendService: GeneralCourseRecommendService,
)
```

### available-chapels

```kotlin
fun getAvailableChapels(timetableId: Long): AvailableChapelsResponse {
    val ctx = recommendContextResolver.resolveOptional()
    val satisfied = ctx?.graduationSummary?.chapel?.satisfied

    val courses = // 기존 채플 과목 조회 로직 그대로

    return AvailableChapelsResponse(satisfied, courses)
}
```

### available-general-electives

```kotlin
fun getAvailableGeneralElectives(timetableId: Long): AvailableGeneralElectivesResponse {
    val ctx = recommendContextResolver.resolveOptional()

    val progress = if (ctx != null) {
        val summary = ctx.graduationSummary?.generalElective
        val fieldCredits = generalCourseRecommendService.computeTakenFieldCredits(
            ctx.takenSubjectCodes,
            ctx.schoolId
        )
        GeneralElectiveProgress(
            required = summary?.required,
            completed = summary?.completed,
            satisfied = summary?.satisfied ?: false,
            fieldCredits = fieldCredits
        )
    } else null

    val courses = // 기존 교양선택 과목 조회 로직 그대로

    return AvailableGeneralElectivesResponse(progress, courses)
}
```

### 컨트롤러 반환 타입 변경

```kotlin
// 변경 전
fun getAvailableChapels(...): ResponseEntity<Response<List<TimetableCourseResponse>>>

// 변경 후
fun getAvailableChapels(...): ResponseEntity<Response<AvailableChapelsResponse>>
```

교선도 동일하게 `List<GeneralElectiveDto>` → `AvailableGeneralElectivesResponse`

---

## 최종 응답 예시

### available-chapels

```json
{
   "progress": {
    "satisfied": true,
  },
  "coursTimes": [...]
}
```

### available-general-electives

```json
{
  "progress": {
    "required": 9,
    "completed": 10,
    "satisfied": true,
    "fieldCredits": {
      "인간·언어": 3,
      "문화·예술": 3,
      "사회·정치·경제": 2,
      "과학·기술": 2,
      "자기개발·진로탐색": 0,
    }
  },
  "courseTimes: [...]
}
```

> 로그인 안 된 사용자: `satisfied: null`, `progress: null` — courses만 내려감

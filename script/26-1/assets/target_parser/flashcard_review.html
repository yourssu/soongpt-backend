<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ê°•ëŒ€ìƒ íŒŒì‹± ê²€ì¦ - í”Œë˜ì‹œì¹´ë“œ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .card-container {
            perspective: 1000px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }

        .card {
            position: relative;
            width: 100%;
            height: 500px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-front {
            background: white;
        }

        .card-back {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transform: rotateY(180deg);
        }

        .card-number {
            font-size: 14px;
            color: #999;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: right;
            width: 100%;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }



        .original-text {
            font-size: 24px;
            line-height: 1.6;
            font-weight: 500;
            color: #2d3748;
            white-space: pre-wrap;
        }

        .parsed-content {
            overflow-y: auto;
            max-height: 400px;
        }

        .target-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .target-header {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Update controls in renderCard */
        /* Since we can't easily edit renderCard func, we hook into it via existing call sites or override it. */
        /* I will replace the END of renderCard to call updateControls */

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-university {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-college {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-department {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge-excluded {
            background: #ffebee;
            color: #c62828;
        }

        .badge-foreigner {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-confidence-low {
            background: #ffebee;
            color: #c62828;
            font-weight: 700;
        }

        .badge-confidence-medium {
            background: #fff3e0;
            color: #e65100;
            font-weight: 700;
        }

        .badge-confidence-high {
            background: #e8f5e9;
            color: #388e3c;
            font-weight: 700;
        }

        .badge-issue {
            background: #e3f2fd;
            color: #1565c0;
            font-size: 11px;
        }

        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .field {
            font-size: 13px;
        }

        .field-label {
            color: #718096;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .field-value {
            color: #2d3748;
            font-weight: 600;
            font-size: 15px;
            /* Larger text */
        }

        .grade-circles {
            display: flex;
            gap: 4px;
        }

        .grade-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #edf2f7;
            color: #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .grade-circle.active {
            background: #667eea;
            color: white;
        }

        .target-main-info {
            font-size: 18px;
            font-weight: 700;
            color: #2b6cb0;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .target-sub-info {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 12px;
        }

        .field-value input,
        .field-value select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-prev,
        .btn-next {
            background: white;
            color: #667eea;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            padding: 0;
            justify-content: center;
        }

        .btn-review-complete {
            background: #48bb78;
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        .btn-flip {
            background: #667eea;
            color: white;
        }

        .btn-save {
            background: #4299e1;
            color: #edf2f7;
        }

        .btn-filter {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: #edf2f7;
            padding: 8px 16px;
            font-size: 13px;
        }

        .progress {
            width: 100%;
            max-width: 800px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 13px;
            backdrop-filter: blur(10px);
            z-index: 100;
            display: block;
            /* Always visible */
        }

        /* Removed .show class as it is always visible */

        .keyboard-shortcuts kbd {
            background: #555;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 0 3px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        select {
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        select option {
            background: #667eea;
            color: white;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-indicator.show {
            opacity: 1;
        }

        .status-correct {
            background: #48bb78;
            color: white;
        }

        .status-incorrect {
            background: #f56565;
            color: white;
        }

        .edit-mode-banner {
            background: #fbbf24;
            color: #78350f;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .card-container.slide-right {
            animation: slideInRight 0.4s ease;
        }

        .card-container.slide-left {
            animation: slideInLeft 0.4s ease;
        }

        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }


            .original-text {
                font-size: 22px;
            }

            .controls {
                flex-wrap: wrap;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            /* Increased width for JSON view */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .error-list {
            padding: 10px;
            background: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            text-align: left;
            white-space: pre-wrap;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 300px;
            margin-bottom: 10px;
        }

        .btn-error {
            background: #fc8181;
            color: white;
        }

        .btn-error.active {
            background: #e53e3e;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 12px;
            color: #999;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .content-section {
            margin-bottom: 25px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ“š ìˆ˜ê°•ëŒ€ìƒ íŒŒì‹± ê²€ì¦</h1>
        <div class="stats">
            <div class="stat">ğŸ“Š <span id="current-num">1</span> / <span id="total-count">0</span></div>
            <div class="stat">âœ… ì™„ë£Œ: <span id="reviewed-count">0</span></div>
            <div class="stat">â³ ë‚¨ìŒ: <span id="pending-count">0</span></div>
        </div>
    </div>

    <div class="progress">
        <div class="progress-fill" id="progress-fill"></div>
    </div>

    <div class="filters">
        <select id="scope-filter" onchange="applyFilters()">
            <option value="all">ğŸ¯ ëª¨ë“  Scope</option>
            <option value="UNIVERSITY">ğŸ« UNIVERSITY</option>
            <option value="COLLEGE">ğŸ›ï¸ COLLEGE</option>
            <option value="DEPARTMENT">ğŸ“ DEPARTMENT</option>
        </select>
        <select id="status-filter" onchange="applyFilters()">
            <option value="all">ğŸ“‹ ëª¨ë“  ìƒíƒœ</option>
            <option value="pending">â³ ë¯¸ê²€í† </option>
            <option value="reviewed">âœ… ê²€í† ì™„ë£Œ</option>
        </select>
    </div>

    <div class="card-container" id="card-container">
        <div class="card" id="card">
            <div class="card-number">
                <input type="number" id="jump-input"
                    style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 14px;"
                    onchange="jumpToCard(this.value)" placeholder="1">
                / <span id="total-card-count">0</span> | <span style="color: #667eea" id="card-count">0ê±´</span>
            </div>
            <div class="status-indicator" id="status-indicator"></div>

            <!-- Metadata Section (for suspicious items) -->
            <div id="metadata-section" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <div id="confidence-badge" class="badge" style="font-size: 14px;"></div>
                    <div id="issues-badges" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                </div>
            </div>

            <div>
                <div class="section-title">ORIGINAL TEXT</div>
                <div class="content-section">
                    <div class="original-text" id="original-text">
                        íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>

            <div>
                <div class="section-title">PARSED TARGETS</div>
                <div class="parsed-content" id="parsed-content">
                    <!-- Parsed targets will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-prev" onclick="prevCard()" title="ì´ì „ (â†)">
            â—€
        </button>

        <button class="btn btn-filter" onclick="toggleError()" id="error-btn" title="ì˜¤ë¥˜ í‘œì‹œ (E)">
            âš ï¸ ì˜¤ë¥˜ í‘œì‹œ
        </button>

        <button class="btn btn-filter" onclick="toggleEditMode()" id="edit-btn-main" title="ìˆ˜ì • ëª¨ë“œ">
            âœï¸ ìˆ˜ì •
        </button>

        <button class="btn btn-next" onclick="nextCard()" title="ë‹¤ìŒ (â†’)">
            â–¶
        </button>
    </div>

    <div class="controls">
        <button class="btn btn-filter" onclick="openFile()" title="íŒŒì¼ ì—´ê¸° (O)">
            ğŸ“‚ ì—´ê¸°
        </button>
        <button class="btn btn-filter" onclick="nextUnreviewed()" title="ë‹¤ìŒ ë¯¸ê²€í† ">
            â© ë‹¤ìŒ ë¯¸ê²€í† 
        </button>
        <button class="btn btn-save" onclick="showReport()" title="ê²°ê³¼ ë¦¬í¬íŠ¸ (U)">
            ğŸ“Š ê²°ê³¼ ë¦¬í¬íŠ¸
        </button>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="report-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“‰ ì˜¤ë¥˜ í•­ëª© ì›ë³¸ ë¦¬ìŠ¤íŠ¸</div>
            <div class="modal-body" style="display: flex; flex-direction: column; height: 100%;">
                <p style="margin-bottom: 10px; font-size: 13px; color: #666;">
                    ì•„ë˜ëŠ” <strong>ì˜¤ë¥˜ í‘œì‹œë¨</strong> í•­ëª©ë“¤ì˜ ì›ë³¸ JSONì…ë‹ˆë‹¤.<br>
                    ì „ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ìˆ˜ì •ìš© JSON íŒŒì¼ì„ ë§Œë“œëŠ”ë° ì‚¬ìš©í•˜ì„¸ìš”.
                </p>
                <textarea class="error-list" id="report-indices" readonly>
                        -
                    </textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-save" onclick="copyIndices()" style="flex: 1;">
                        ğŸ“‹ ë³µì‚¬í•˜ê¸°
                    </button>
                    <button class="btn" onclick="resetErrors()"
                        style="flex: 0 0 100px; background: #fc8181; color: white;">ì´ˆê¸°í™”</button>
                    <button class="btn" onclick="closeReport()"
                        style="flex: 0 0 100px; background: #cbd5e0; color: #2d3748;">ì¢…ë£Œ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="keyboard-shortcuts" id="keyboard-shortcuts">
        <div style="margin-bottom: 10px; font-weight: 600;">âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Mac: Cmd í•„ìˆ˜)</div>
        <div><kbd>â†</kbd> <kbd>â†’</kbd> ì´ì „/ë‹¤ìŒ</div>
        <div><kbd>Enter</kbd> ë‹¤ìŒ ì¹´ë“œ</div>
        <div><kbd>E</kbd> ì˜¤ë¥˜ í‘œì‹œ í† ê¸€</div>
        <div><kbd>U</kbd> ì˜¤ë¥˜ ë¦¬í¬íŠ¸ ë³´ê¸°</div>
    </div>



    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileSelect(event)">

    <script>
        let data = [];
        let filteredData = [];
        let currentIndex = 0;
        let reviews = {};
        let editMode = false;
        let fileHandle = null;

        async function openFile() {
            // Basic file input fallback only
            document.getElementById('file-input').click();
        }

        function loadData(jsonText) {
            try {
                const loaded = JSON.parse(jsonText);
                if (Array.isArray(loaded)) {
                    data = loaded;
                } else if (loaded.data && Array.isArray(loaded.data)) {
                    data = loaded.data;
                } else {
                    throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ JSON í˜•ì‹ì…ë‹ˆë‹¤.');
                }

                filteredData = [...data];
                reviews = {};
                data.forEach((item, index) => {
                    if (item.review_status === 'reviewed') {
                        reviews[index] = 'reviewed';
                    }
                });

                currentIndex = 0;
                renderCard();
                updateStats();
            } catch (error) {
                alert('JSON íŒŒì‹± ì˜¤ë¥˜: ' + error.message);
            }
        }



        // Local Storage Key
        const STORAGE_KEY = 'flashcard_data_v1';

        function saveToLocalStorage() {
            const state = {
                data: data,
                reviews: reviews,
                lastIndex: currentIndex
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function clearLocalStorage() {
            if (confirm('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        window.onload = async function () {
            // Try loading from LocalStorage first
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.data) {
                        data = parsed.data;
                        reviews = parsed.reviews || {};
                        filteredData = [...data];
                        currentIndex = parsed.lastIndex || 0;
                        updateStats(); // Initial stats update
                        renderCard();
                        console.log('Restored from LocalStorage');
                        return;
                    }
                } catch (e) {
                    console.error('Storage load failed', e);
                }
            }

            // Auto open if handled via fetch
            try {
                const response = await fetch('parsed_unique_targets.json');
                if (response.ok) {
                    const text = await response.text();
                    loadData(text);
                }
            } catch (e) {
                console.log('Auto-fetch failed, waiting for user input');
                document.getElementById('original-text').textContent =
                    'íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš” (ğŸ“‚ ì—´ê¸° ë²„íŠ¼)';
            }
        };

        function renderCard() {
            if (filteredData.length === 0) {
                document.getElementById('original-text').textContent = 'í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            const item = filteredData[currentIndex];

            const currentNum = currentIndex + 1;
            const totalNum = filteredData.length;

            document.getElementById('jump-input').value = currentNum;
            document.getElementById('total-card-count').textContent = totalNum;
            document.getElementById('card-count').textContent = `${item.count}ê±´`;
            document.getElementById('original-text').textContent = item.original_text;
            document.getElementById('current-num').textContent = currentNum;

            // Render metadata if available (for suspicious items)
            const metadataSection = document.getElementById('metadata-section');
            if (item._metadata) {
                const confidence = item._metadata.confidence || 'unknown';
                const issues = item._metadata.issues || [];

                // Confidence badge
                const confidenceMap = {
                    'low': { text: 'ğŸ”´ ì‹ ë¢°ë„: ë‚®ìŒ', class: 'badge-confidence-low' },
                    'medium': { text: 'ğŸŸ¡ ì‹ ë¢°ë„: ë³´í†µ', class: 'badge-confidence-medium' },
                    'high': { text: 'ğŸŸ¢ ì‹ ë¢°ë„: ë†’ìŒ', class: 'badge-confidence-high' }
                };
                const confInfo = confidenceMap[confidence] || { text: 'â“ ì‹ ë¢°ë„: ë¯¸ìƒ', class: 'badge' };

                document.getElementById('confidence-badge').textContent = confInfo.text;
                document.getElementById('confidence-badge').className = 'badge ' + confInfo.class;

                // Issue badges
                const issueNames = {
                    'unmapped_tokens': 'âŒ ë¯¸ë§¤í•‘ í† í°',
                    'no_parsing': 'âš ï¸ íŒŒì‹± ì‹¤íŒ¨',
                    'multiple_departments': 'ğŸ“š ë‹¤ì¤‘ í•™ê³¼',
                    'strict_without_specifics': 'ğŸ¯ ì• ë§¤í•œ ì œí•œ',
                    'ambiguous_university_scope': 'ğŸ« ì• ë§¤í•œ ì „ì²´',
                    'oversimplified': 'ğŸ“‰ ê³¼ë‹¨ìˆœí™”',
                    'exclusion_without_base': 'ğŸš« ê¸°ì¤€ ëˆ„ë½'
                };

                const issueHtml = issues.map(issue => {
                    const displayName = issueNames[issue] || issue;
                    return `<span class="badge badge-issue">${displayName}</span>`;
                }).join('');

                document.getElementById('issues-badges').innerHTML = issueHtml;
                metadataSection.style.display = 'block';
            } else {
                metadataSection.style.display = 'none';
            }

            // Updated Parsed Content
            const parsedHtml = item.parsed_targets.map((target, tIndex) => {
                if (editMode) {
                    const minGrade = target.Condition?.Grade?.min || 1;
                    const maxGrade = target.Condition?.Grade?.max || 5;
                    const studentTypes = target.Condition?.StudentType || ['general'];
                    return `
                        <div class="target-item">
                            <div class="target-grid">
                                <div class="field">
                                    <div class="field-label">Effect</div>
                                    <div class="field-value">
                                        <select onchange="updateTarget(${tIndex}, 'Effect', this.value)">
                                            <option value="Allow" ${target.Effect === 'Allow' ? 'selected' : ''}>Allow</option>
                                            <option value="Deny" ${target.Effect === 'Deny' ? 'selected' : ''}>Deny</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="field-label">Resource</div>
                                    <div class="field-value">
                                        <input type="text" value="${target.Resource || ''}" onchange="updateTarget(${tIndex}, 'Resource', this.value)" placeholder="university">
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="field-label">Grade (1-5)</div>
                                    <div class="field-value">
                                        <input type="text" value="${minGrade}-${maxGrade}" onchange="updateGradeRange(${tIndex}, this.value)" style="width: 60px;">
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="field-label">StudentType</div>
                                    <div class="field-value" style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                                        <label><input type="checkbox" ${studentTypes.includes('general') ? 'checked' : ''} onchange="updateStudentType(${tIndex}, 'general', this.checked)"> ì¼ë°˜</label>
                                        <label><input type="checkbox" ${studentTypes.includes('foreigner') ? 'checked' : ''} onchange="updateStudentType(${tIndex}, 'foreigner', this.checked)"> ğŸŒ ì™¸êµ­ì¸</label>
                                        <label><input type="checkbox" ${studentTypes.includes('military') ? 'checked' : ''} onchange="updateStudentType(${tIndex}, 'military', this.checked)"> ï¿½ï¸ êµ°ìœ„íƒ</label>
                                        <label><input type="checkbox" ${studentTypes.includes('teaching_cert') ? 'checked' : ''} onchange="updateStudentType(${tIndex}, 'teaching_cert', this.checked)"> ğŸ‘¨â€ï¿½ êµì§</label>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="field-label">Strict</div>
                                    <div class="field-value">
                                        <label><input type="checkbox" ${target.Strict ? 'checked' : ''} onchange="updateTarget(${tIndex}, 'Strict', this.checked)"> âš ï¸ Strict</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                     `;
                }

                // Parse Resource to get scopeType and name
                const resource = target.Resource || 'university';
                let scopeType, displayName;
                if (resource === 'university') {
                    scopeType = 'UNIVERSITY';
                    displayName = '(ì „ì²´)';
                } else if (resource.startsWith('college/')) {
                    scopeType = 'COLLEGE';
                    displayName = resource.replace('college/', '');
                } else if (resource.startsWith('department/')) {
                    scopeType = 'DEPARTMENT';
                    displayName = resource.replace('department/', '');
                } else {
                    scopeType = 'UNKNOWN';
                    displayName = resource;
                }

                const isExcluded = target.Effect === 'Deny';
                const isForeignerOnly = target.Condition?.StudentType?.includes('foreigner');
                const isMilitaryOnly = target.Condition?.StudentType?.includes('military');
                const isTeachingCert = target.Condition?.StudentType?.includes('teaching_cert');

                return `
                    <div class="target-item">
                        <div class="target-header">
                            <span class="badge badge-${scopeType.toLowerCase()}">${scopeType}</span>
                            ${isExcluded ? '<span class="badge badge-excluded">ğŸš« ì œì™¸</span>' : ''}
                            ${isForeignerOnly ? '<span class="badge badge-foreigner">ğŸŒ ì™¸êµ­ì¸</span>' : ''}
                            ${isMilitaryOnly ? '<span class="badge" style="background: #fef3c7; color: #92400e;">ğŸ–ï¸ êµ°ìœ„íƒ</span>' : ''}
                            ${isTeachingCert ? '<span class="badge" style="background: #dbeafe; color: #1e40af;">ğŸ‘¨â€ğŸ« êµì§</span>' : ''}
                            ${target.Strict ? '<span class="badge" style="background: #fee2e2; color: #991b1b;">âš ï¸ ëŒ€ìƒì™¸</span>' : ''}
                        </div>
                        
                        <div class="target-main-info">
                            ${displayName}
                        </div>

                        <div class="target-grid">
                            <div class="field">
                                <div class="field-label">í•™ë…„</div>
                                <div class="field-value">
                                    <div class="grade-circles">
                                        ${[1, 2, 3, 4, 5].map(g => {
                    const minGrade = target.Condition?.Grade?.min || 1;
                    const maxGrade = target.Condition?.Grade?.max || 5;
                    const isActive = g >= minGrade && g <= maxGrade;
                    return `<div class="grade-circle ${isActive ? 'active' : ''}">${g}</div>`;
                }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('parsed-content').innerHTML = parsedHtml;
            updateControls();
        }

        function updateTarget(targetIndex, field, value) {
            const originalIndex = getOriginalIndex(currentIndex);
            if (field === 'collegeName' || field === 'departmentName') {
                data[originalIndex].parsed_targets[targetIndex][field] = value || null;
            } else {
                data[originalIndex].parsed_targets[targetIndex][field] = value;
            }
            renderCard();
            saveToLocalStorage(); // Auto-save
        }

        function updateBooleanTarget(targetIndex, field, checked) {
            const originalIndex = getOriginalIndex(currentIndex);
            data[originalIndex].parsed_targets[targetIndex][field] = checked;
            renderCard();
            saveToLocalStorage(); // Auto-save
        }

        function updateGradeRange(targetIndex, value) {
            const originalIndex = getOriginalIndex(currentIndex);
            const [min, max] = value.split('-').map(v => parseInt(v.trim()));
            if (!isNaN(min) && !isNaN(max)) {
                const target = data[originalIndex].parsed_targets[targetIndex];
                if (!target.Condition) target.Condition = {};
                target.Condition.Grade = { min, max };
                renderCard();
                saveToLocalStorage(); // Auto-save
            }
        }

        function updateStudentType(targetIndex, type, checked) {
            const originalIndex = getOriginalIndex(currentIndex);
            const target = data[originalIndex].parsed_targets[targetIndex];
            if (!target.Condition) target.Condition = {};
            if (!target.Condition.StudentType) target.Condition.StudentType = ['general'];

            let types = [...target.Condition.StudentType];
            if (checked && !types.includes(type)) {
                types.push(type);
                // Remove 'general' if a specific type is added
                if (type !== 'general') {
                    types = types.filter(t => t !== 'general');
                }
            } else if (!checked) {
                types = types.filter(t => t !== type);
                // Default to 'general' if all types removed
                if (types.length === 0) types = ['general'];
            }
            target.Condition.StudentType = types;
            renderCard();
            saveToLocalStorage();
        }

        function nextCard() {
            // Auto-review when moving to next if not already reviewed
            const originalIndex = getOriginalIndex(currentIndex);
            if (!reviews[originalIndex]) {
                markReviewed(false); // Do not advance in markReviewed, we do it here
            }

            if (currentIndex < filteredData.length - 1) {
                currentIndex++;
                document.getElementById('card-container').classList.remove('slide-left', 'slide-right');
                setTimeout(() => {
                    document.getElementById('card-container').classList.add('slide-right');
                    renderCard();
                }, 10);
            } else {
                alert('ë§ˆì§€ë§‰ í•­ëª©ì…ë‹ˆë‹¤.');
            }
        }

        function prevCard() {
            if (currentIndex > 0) {
                currentIndex--;
                document.getElementById('card-container').classList.remove('slide-left', 'slide-right');
                setTimeout(() => {
                    document.getElementById('card-container').classList.add('slide-left');
                    renderCard();
                }, 10);
            }
        }

        function toggleError() {
            const originalIndex = getOriginalIndex(currentIndex);
            if (data[originalIndex].isError) {
                data[originalIndex].isError = false;
                showStatus('ì˜¤ë¥˜ í•´ì œ', 'status-correct');
            } else {
                data[originalIndex].isError = true;
                reviews[originalIndex] = 'reviewed'; // Marking error counts as reviewed
                showStatus('ì˜¤ë¥˜ í‘œì‹œë¨ âš ï¸', 'status-incorrect');
            }
            renderCard();
            updateStats();
            saveToLocalStorage(); // Auto-save
        }

        function markReviewed(shouldAdvance = true) {
            const originalIndex = getOriginalIndex(currentIndex);

            // í¸ì§‘ ëª¨ë“œê°€ í•­ìƒ ì¼œì ¸ìˆì–´ í† ê¸€ í•„ìš” ì—†ìŒ

            if (reviews[originalIndex] !== 'reviewed') {
                reviews[originalIndex] = 'reviewed';
                showStatus('ê²€í†  ì™„ë£Œ âœ…', 'status-correct');
                updateStats();
                saveToLocalStorage(); // Auto-save
            }

            if (shouldAdvance) {
                setTimeout(() => {
                    if (currentIndex < filteredData.length - 1) {
                        nextUnreviewed() || nextCard();
                    } else {
                        alert('ê²€í† ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                }, 200);
            }
        }

        function showStatus(text, className) {
            const indicator = document.getElementById('status-indicator');
            indicator.textContent = text;
            indicator.className = 'status-indicator show ' + className;
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }

        function nextUnreviewed() {
            for (let i = currentIndex + 1; i < filteredData.length; i++) {
                const originalIndex = getOriginalIndex(i);
                if (!reviews[originalIndex]) {
                    currentIndex = i;
                    renderCard();
                    return true;
                }
            }
            // ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì°¾ê¸°
            for (let i = 0; i < currentIndex; i++) {
                const originalIndex = getOriginalIndex(i);
                if (!reviews[originalIndex]) {
                    currentIndex = i;
                    renderCard();
                    return true;
                }
            }
            return false;
        }

        function getOriginalIndex(filteredIndex) {
            return data.indexOf(filteredData[filteredIndex]);
        }

        function updateStats() {
            const total = data.length;
            const reviewed = Object.values(reviews).filter(r => r === 'reviewed').length;
            const pending = total - reviewed;

            document.getElementById('total-count').textContent = total;
            document.getElementById('reviewed-count').textContent = reviewed;
            document.getElementById('pending-count').textContent = pending;

            const percentage = total > 0 ? (reviewed / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';
        }


        function jumpToCard(val) {
            const num = parseInt(val);
            if (!isNaN(num) && num >= 1 && num <= filteredData.length) {
                currentIndex = num - 1;
                renderCard();
            } else {
                alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                document.getElementById('jump-input').value = currentIndex + 1;
            }
        }

        function applyFilters() {
            const scopeFilter = document.getElementById('scope-filter').value;
            const statusFilter = document.getElementById('status-filter').value;

            filteredData = data.filter((item, index) => {
                // Scope filter (based on Resource prefix)
                if (scopeFilter !== 'all') {
                    const resourcePrefix = scopeFilter.toLowerCase();
                    const hasScope = item.parsed_targets.some(t => {
                        const resource = t.Resource || '';
                        if (resourcePrefix === 'university') return resource === 'university';
                        if (resourcePrefix === 'college') return resource.startsWith('college/');
                        if (resourcePrefix === 'department') return resource.startsWith('department/');
                        return false;
                    });
                    if (!hasScope) return false;
                }

                // Status filter
                if (statusFilter !== 'all') {
                    const status = reviews[index];
                    if (statusFilter === 'pending' && status) return false;
                    if (statusFilter === 'reviewed' && status !== 'reviewed') return false;
                }

                return true;
            });

            currentIndex = 0;
            renderCard();
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('edit-btn-main');
            btn.textContent = editMode ? 'ğŸ‘ï¸ ë³´ê¸°' : 'âœï¸ ìˆ˜ì •';
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í† ê¸€ì„ ìœ„í•´ í´ë˜ìŠ¤ ì¡°ì‘
            if (editMode) {
                btn.style.background = '#fbbf24';
                btn.style.color = '#78350f';
            } else {
                btn.style.background = ''; // ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µê·€ (CSS í´ë˜ìŠ¤ì— ì˜ì¡´)
                btn.style.color = '';
            }
            renderCard();
        }

        async function exportResults() {
            // í˜„ì¬ ìƒíƒœë¥¼ ë°˜ì˜í•œ ë°ì´í„° ìƒì„±
            const exportData = data.map((item, index) => ({
                ...item,
                review_status: reviews[index] || 'pending'
            }));

            // File System Access API ì‚¬ìš© ì‹œë„ (Chrome, Edge ë“±)
            if (window.showSaveFilePicker) {
                try {
                    const options = {
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] },
                        }],
                    };

                    // íŒŒì¼ í•¸ë“¤ì´ ìˆìœ¼ë©´ ê·¸ê²ƒ ì‚¬ìš© (ë®ì–´ì“°ê¸°), ì—†ìœ¼ë©´ ì €ì¥ ëŒ€í™”ìƒì
                    // ë³´ì•ˆìƒ í•­ìƒ ëŒ€í™”ìƒìê°€ ëœ° ìˆ˜ ìˆìŒ
                    const handle = fileHandle || await window.showSaveFilePicker(options);
                    const writable = await handle.createWritable();
                    await writable.write(JSON.stringify(exportData, null, 2));
                    await writable.close();

                    showStatus('ì €ì¥ ì™„ë£Œ âœ…', 'status-correct');
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('File System Access API Error:', err);
                        // ì‹¤íŒ¨ì‹œ ë‹¤ìš´ë¡œë“œ ë°©ì‹ìœ¼ë¡œ í´ë°±
                    } else {
                        return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨
                    }
                }
            }

            // Fallback: ê¸°ì¡´ ë‹¤ìš´ë¡œë“œ ë°©ì‹
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parsed_unique_targets_reviewed.json`; // ê¸°ë³¸ íŒŒì¼ëª… ë³€ê²½
            a.click();
            URL.revokeObjectURL(url);

            showStatus('ì €ì¥ ì™„ë£Œ (ë‹¤ìš´ë¡œë“œ) ğŸ’¾', 'status-correct');
        }

        function updateControls() {
            const originalIndex = getOriginalIndex(currentIndex);
            const isErr = data[originalIndex].isError;
            const errBtn = document.getElementById('error-btn');
            if (errBtn) {
                if (isErr) {
                    errBtn.classList.add('active');
                    errBtn.style.background = '#e53e3e';
                } else {
                    errBtn.classList.remove('active');
                    errBtn.style.background = '';
                }
            }
        }

        function showReport() {
            // Collect Error Items (Full JSON)
            const errorItems = data.filter(item => item.isError).map(item => {
                // We probably want to exclude transient fields like isError if saving as clean JSON, 
                // but user asked for "Original JSON".
                const { isError, review_status, ...rest } = item;
                return rest;
            });

            const jsonString = JSON.stringify(errorItems, null, 2);
            document.getElementById('report-indices').value = jsonString; // Use value for textarea
            document.getElementById('report-modal').classList.add('show');
        }

        function closeReport() {
            document.getElementById('report-modal').classList.remove('show');
        }

        function copyIndices() {
            const text = document.getElementById('report-indices').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ (' + text.length + ' ì)');
            });
        }

        function resetErrors() {
            if (!confirm('ì •ë§ ëª¨ë“  ì˜¤ë¥˜ í‘œì‹œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) return;

            data.forEach(item => {
                item.isError = false;
            });

            // Re-calc stats and save
            updateStats();
            renderCard(); // Update UI if current card was error
            saveToLocalStorage();

            alert('ëª¨ë“  ì˜¤ë¥˜ í‘œì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeReport();
        }

        function downloadJson() {
            const exportData = data.map((item, index) => ({
                ...item,
                review_status: reviews[index] || 'pending'
            }));
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parsed_unique_targets_reviewed.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // toggleHelp function removed

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                loadData(e.target.result);
            };
            reader.readAsText(file);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë‹¨ì¶•í‚¤ ë¹„í™œì„±í™”
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            switch (e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    prevCard();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextCard();
                    break;

                case 'Enter':
                    e.preventDefault();
                    // Just next, no special review mark needed as default is pending/viewed
                    nextCard();
                    break;

                case 'e':
                case 'E':
                    e.preventDefault();
                    toggleError();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    exportResults();
                    break;
                case 'm':
                case 'M':
                    // M shortcut removed
                    break;
                case 'u':
                case 'U':
                    e.preventDefault();
                    showReport();
                    break;
                // Help toggle removed
            }
        });


    </script>
</body>

</html>
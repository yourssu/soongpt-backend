name: Gradle Test Build

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'rusaint_service/**'
      - '.github/workflows/backend-test.yml'

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      rusaint: ${{ steps.filter.outputs.rusaint }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'src/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
            rusaint:
              - 'rusaint_service/**'
              - '.github/workflows/backend-test.yml'

  test-and-build:
    needs: changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main' && needs.changes.outputs.backend == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests and build
        id: test
        run: |
          ./gradlew clean build --info > build-log.txt 2>&1
          echo "status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse test results
        id: parse-results
        if: always()
        run: |
          if [ -d "build/test-results/test" ]; then
            total_tests=$(find build/test-results/test -name "*.xml" -exec grep -o 'tests="[0-9]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            failures=$(find build/test-results/test -name "*.xml" -exec grep -o 'failures="[0-9]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            errors=$(find build/test-results/test -name "*.xml" -exec grep -o 'errors="[0-9]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')

            echo "total=${total_tests:-0}" >> $GITHUB_OUTPUT
            echo "failures=${failures:-0}" >> $GITHUB_OUTPUT
            echo "errors=${errors:-0}" >> $GITHUB_OUTPUT
            echo "passed=$((${total_tests:-0} - ${failures:-0} - ${errors:-0}))" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "failures=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            build/reports/tests/test/
            build/test-results/test/
            build-log.txt
          retention-days: 7

      - name: Comment test results on PR
        uses: actions/github-script@v7
        if: always()
        env:
          TOTAL_TESTS: ${{ steps.parse-results.outputs.total }}
          PASSED_TESTS: ${{ steps.parse-results.outputs.passed }}
          FAILED_TESTS: ${{ steps.parse-results.outputs.failures }}
          ERROR_TESTS: ${{ steps.parse-results.outputs.errors }}
          BUILD_STATUS: ${{ steps.test.outputs.status }}
        with:
          script: |
            const total = process.env.TOTAL_TESTS || '0';
            const passed = process.env.PASSED_TESTS || '0';
            const failed = process.env.FAILED_TESTS || '0';
            const errors = process.env.ERROR_TESTS || '0';
            const buildStatus = process.env.BUILD_STATUS;

            const success = buildStatus === '0';
            const statusEmoji = success ? 'âœ…' : 'âŒ';
            const statusText = success ? 'PASSED' : 'FAILED';

            let comment = `## ${statusEmoji} í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰ ë³´ê³ ì„œ \n\n`;
            comment += `### ğŸ“Š Test Summary\n`;
            comment += `- **Total Tests**: ${total}\n`;
            comment += `- **âœ… Passed**: ${passed}\n`;
            comment += `- **âŒ Failed**: ${failed}\n`;
            comment += `- **âš ï¸ Errors**: ${errors}\n\n`;

            if (!success) {
              comment += `### ğŸ” Details\n`;
              comment += `í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ ë§í¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.\n\n`;
            }

            comment += `[ğŸ“ View detailed test reports](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail workflow if tests failed
        if: steps.test.outputs.status != '0'
        run: exit 1

  rusaint-service-test:
    needs: changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main' && needs.changes.outputs.rusaint == 'true'

    defaults:
      run:
        working-directory: rusaint_service

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements-test.txt

      - name: Run rusaint_service tests
        run: pytest -v
